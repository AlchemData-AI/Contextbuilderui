# Golden Queries Feedback Loop - Complete âœ…

## Overview

Added a powerful feedback loop to the Golden Queries configuration page that enables analysts to continuously improve the golden query set by reviewing and validating queries generated during actual user conversations.

---

## The Problem

Traditional golden query sets are static and created upfront during agent setup. However:
- Users ask questions in different ways than anticipated
- New patterns emerge from actual usage
- AI generates queries that work well but aren't in the golden set
- No mechanism to capture and validate these successful queries

---

## The Solution

### New Queries from Conversations Section

A dedicated section that shows queries the AI agent created during user conversations that are **not yet part of the golden query set**.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‘¥ New Queries from User Conversations (3)        â”‚
â”‚ These queries were generated by your AI agent      â”‚
â”‚ during user conversations. Review and validate     â”‚
â”‚ to add them to your golden set.                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚ â”‚ Query Card 1     â”‚  â”‚ Query Card 2     â”‚        â”‚
â”‚ â”‚                  â”‚  â”‚                  â”‚        â”‚
â”‚ â”‚ â€¢ Usage stats    â”‚  â”‚ â€¢ Usage stats    â”‚        â”‚
â”‚ â”‚ â€¢ User feedback  â”‚  â”‚ â€¢ User feedback  â”‚        â”‚
â”‚ â”‚ â€¢ Conversations  â”‚  â”‚ â€¢ Conversations  â”‚        â”‚
â”‚ â”‚ â€¢ Editable SQL   â”‚  â”‚ â€¢ Editable SQL   â”‚        â”‚
â”‚ â”‚                  â”‚  â”‚                  â”‚        â”‚
â”‚ â”‚ [Dismiss] [Add]  â”‚  â”‚ [Dismiss] [Add]  â”‚        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Key Features

### 1. **Query Discovery** ğŸ”
```typescript
interface NewQuery {
  id: string;
  question: string;
  sqlQuery: string;
  usageCount: number;              // How many times used
  lastUsed: string;                // Recency
  userFeedback: {
    positive: number;              // Thumbs up
    negative: number;              // Thumbs down
  };
  conversations: [...];            // All conversations using this query
  involvedAgents: string[];        // Which agents were involved
}
```

### 2. **Usage Analytics** ğŸ“Š

Each query card shows:
- **Usage Count**: Total number of times the query was used
- **Last Used**: Time since last usage (e.g., "2 hours ago")
- **User Feedback**: Positive/negative thumbs up/down counts
- **Success Rate**: Calculated percentage

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Last Used      â”‚ User Feedback  â”‚
â”‚ 2 hours ago    â”‚ ğŸ‘ 9  ğŸ‘ 1     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. **Conversation Context** ğŸ’¬

Click "View Conversations" to see:
- Who asked the question
- When they asked it
- How they phrased it (variations)
- What answer they received
- User feedback on each conversation

```
Dialog: User Conversations
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Usage Summary                            â”‚
â”‚ Total Uses: 12                           â”‚
â”‚ Last Used: 2 hours ago                   â”‚
â”‚ Success Rate: 90%                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Conversation History (3)                 â”‚
â”‚                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ SC Sarah Chen â€¢ 2024-10-27 09:15   â”‚  â”‚
â”‚ â”‚ Q: Show me products with declining  â”‚  â”‚
â”‚ â”‚    sales in the last 3 months      â”‚  â”‚
â”‚ â”‚ A: Found 23 products with declining â”‚  â”‚
â”‚ â”‚    sales trends. Top declining...   â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ MJ Mike Johnson â€¢ 2024-10-27 11:30 â”‚  â”‚
â”‚ â”‚ Q: Which products are selling less  â”‚  â”‚
â”‚ â”‚    this month?                      â”‚  â”‚
â”‚ â”‚ A: 23 products showing sales        â”‚  â”‚
â”‚ â”‚    decline this month...            â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. **SQL Validation & Editing** âœï¸

Analysts can:
- View the generated SQL query
- Click "Edit SQL" to make corrections
- Modify the query before adding to golden set
- Save changes and then add to golden set

```
View SQL Query                   [Edit SQL]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SELECT                                   â”‚
â”‚   p.name,                                â”‚
â”‚   SUM(oi.quantity) as total_sales       â”‚
â”‚ FROM products p                          â”‚
â”‚ ...                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

After clicking "Edit SQL":
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Editable Textarea]                      â”‚
â”‚ SELECT                                   â”‚
â”‚   p.name,                                â”‚
â”‚   SUM(oi.quantity) as total_sales       â”‚
â”‚ ...                                      â”‚
â”‚                                          â”‚
â”‚ [Save Changes] [Cancel]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. **Two Actions** âœ…âŒ

Each query can be:

**Dismiss**: Remove from the list (query wasn't good enough)
```javascript
handleRejectNewQuery(queryId)
// Removes from newQueries list
// Toast: "Query dismissed"
```

**Add to Golden Set**: Validate and add to golden queries
```javascript
handleAddNewQueryToGolden(newQuery, useEditedSQL)
// Creates GoldenQuery from NewQuery
// Uses edited SQL if modified
// Adds to golden query set
// Removes from new queries
// Toast: "Query added to golden set"
```

---

## User Workflow

### Analyst's Perspective

```
1. Navigate to Golden Queries page
   â†“
2. See banner: "3 new queries from conversations"
   â†“
3. For each query:
   
   Option A: Quick Validation
   â”œâ”€ Check usage count (12 uses)
   â”œâ”€ Check feedback (9 ğŸ‘, 1 ğŸ‘)
   â”œâ”€ View SQL
   â””â”€ Click "Add to Golden Set"
   
   Option B: Thorough Review
   â”œâ”€ Check usage stats
   â”œâ”€ Click "View Conversations"
   â”œâ”€ Review how 3 different users asked
   â”œâ”€ See AI responses
   â”œâ”€ Click "Edit SQL" if needed
   â”œâ”€ Make corrections
   â””â”€ Click "Add to Golden Set"
   
   Option C: Dismiss
   â””â”€ Click "Dismiss" (not valuable)
```

### Example Scenarios

#### Scenario 1: High-Confidence Addition
```
Query: "Show me products with declining sales"
Usage: 12 times
Feedback: 9 ğŸ‘, 1 ğŸ‘ (90% success)
Action: Quick add âœ…
```

#### Scenario 2: Needs SQL Correction
```
Query: "Average time between customer orders"
Usage: 8 times
Feedback: 7 ğŸ‘, 0 ğŸ‘ (100% success)
SQL: Missing edge case handling
Action: 
  1. Click "Edit SQL"
  2. Add WHERE clause for NULL handling
  3. Save changes
  4. Add to golden set âœ…
```

#### Scenario 3: Poor Quality
```
Query: "Show me stuff"
Usage: 2 times
Feedback: 0 ğŸ‘, 2 ğŸ‘ (0% success)
Action: Dismiss âŒ
```

---

## Data Flow

### Discovery
```
User asks question â†’ AI generates SQL â†’ Query executes â†’ User provides feedback
                                          â†“
                     Query logged with usage data, feedback, conversation
                                          â†“
                     If query NOT in golden set â†’ Add to "New Queries"
```

### Validation Loop
```
Analyst reviews new query
         â†“
   Check usage stats
   Check conversations
   Check SQL quality
         â†“
   Edit SQL (if needed)
         â†“
   Decision:
   â”œâ”€ Add to Golden Set â†’ Becomes validated query
   â””â”€ Dismiss â†’ Removed from consideration
```

### Future Usage
```
User asks similar question
         â†“
   Check golden query set FIRST
         â†“
   If match found:
   â””â”€ Use pre-validated golden query âœ…
         â†“
   If no match:
   â””â”€ Generate new query â†’ Feedback loop starts again ğŸ”„
```

---

## Benefits

### 1. **Continuous Improvement**
- Golden query set grows organically
- Based on actual user needs
- Not limited to initial setup

### 2. **Data-Driven Decisions**
- Usage counts show popularity
- Feedback shows quality
- Conversations show context

### 3. **Quality Assurance**
- Analysts review before adding
- Can correct SQL errors
- Ensures validated responses

### 4. **User-Centric**
- Captures how users actually ask questions
- Not limited to what analysts predict
- Adapts to changing needs

### 5. **Faster Response Times**
- More queries in golden set
- Less SQL generation needed
- Consistent, validated answers

---

## Implementation Details

### New Query Card Structure

```tsx
<Card className="border-2 border-[#6366F1]">
  {/* Header */}
  <div>
    <Badge>From Conversations</Badge>
    <Badge>{usageCount} uses</Badge>
    <h4>{question}</h4>
  </div>

  {/* Involved Agents */}
  <div>
    {involvedAgents.map(...)}
  </div>

  {/* Usage Stats */}
  <div className="grid grid-cols-2">
    <div>Last Used: {lastUsed}</div>
    <div>ğŸ‘ {positive} ğŸ‘ {negative}</div>
  </div>

  {/* View Conversations Button */}
  <Button onClick={showConversations}>
    View {conversationCount} Conversations
  </Button>

  {/* SQL Query (Collapsible + Editable) */}
  <details>
    <summary>View SQL Query [Edit SQL]</summary>
    {editing ? (
      <Textarea value={editedSQL} />
      <Button>Save</Button>
    ) : (
      <pre>{sqlQuery}</pre>
    )}
  </details>

  {/* Actions */}
  <div className="flex gap-2">
    <Button onClick={dismiss}>Dismiss</Button>
    <Button onClick={addToGolden}>Add to Golden Set</Button>
  </div>
</Card>
```

### Conversations Dialog

```tsx
<Dialog>
  <DialogContent className="max-w-3xl">
    {/* Summary Stats */}
    <div className="bg-[#F8F9FA]">
      <div>Total Uses: {usageCount}</div>
      <div>Success Rate: {successRate}%</div>
      <div>ğŸ‘ {positive} ğŸ‘ {negative}</div>
    </div>

    {/* Conversation List */}
    <div>
      {conversations.map(conv => (
        <Card>
          <div>
            <Avatar>{userName}</Avatar>
            <div>
              <p>{userName}</p>
              <p>{timestamp}</p>
            </div>
          </div>
          <div>
            <div>Q: {question}</div>
            <div>A: {answer}</div>
          </div>
        </Card>
      ))}
    </div>
  </DialogContent>
</Dialog>
```

---

## Mock Data

### Example 1: Product Performance Query
```javascript
{
  id: 'new-1',
  question: 'Show me products with declining sales in the last 3 months',
  sqlQuery: `SELECT p.name, ... ORDER BY trend ASC`,
  usageCount: 12,
  lastUsed: '2 hours ago',
  userFeedback: { positive: 9, negative: 1 },
  conversations: [
    {
      userId: 'u1',
      userName: 'Sarah Chen',
      timestamp: '2024-10-27 09:15 AM',
      question: 'Show me products with declining sales...',
      answer: 'Found 23 products with declining sales trends...',
    },
    // ... 2 more conversations
  ],
  involvedAgents: ['Sales Analytics', 'Inventory Management'],
}
```

### Example 2: Customer Behavior Query
```javascript
{
  id: 'new-2',
  question: 'What is the average time between customer orders?',
  usageCount: 8,
  lastUsed: '5 hours ago',
  userFeedback: { positive: 7, negative: 0 },
  // ... more data
}
```

### Example 3: Logistics Query
```javascript
{
  id: 'new-3',
  question: 'Show me shipments delayed by more than 3 days',
  usageCount: 15,
  lastUsed: '1 hour ago',
  userFeedback: { positive: 12, negative: 2 },
  // ... more data
}
```

---

## Visual Hierarchy

### Color System

**Purple Theme** for "New from Conversations":
- Border: `#6366F1` (Indigo/Purple)
- Background: `#F5F5FF` (Light purple tint)
- Badge: Purple with white text
- Distinguishes from AI Generated (teal) and Manual (white)

**Badge Types**:
- ğŸŸ£ **Purple**: From Conversations
- ğŸ”µ **Outline**: Usage count
- ğŸŸ¢ **Green**: Approved
- ğŸŸ  **Orange**: Needs Revision

---

## Success Metrics

### For Analysts
- Time to review queries: ~2-3 min per query
- Validation decisions: Add vs Dismiss ratio
- SQL editing frequency: % requiring edits

### For Users
- Faster responses: More golden queries = less generation time
- Higher accuracy: Validated queries = consistent answers
- Better coverage: Golden set grows with actual usage patterns

### For Product
- Golden query set growth rate
- User satisfaction with responses
- Reduction in AI generation errors

---

## Future Enhancements

### 1. **Auto-Validation Threshold**
```javascript
if (usageCount > 20 && successRate > 95%) {
  // Auto-suggest for golden set
  // "This query is highly successful, recommend adding"
}
```

### 2. **Similar Query Detection**
```javascript
// Group similar queries together
"Show declining products" 
+ "Which products are selling less"
+ "Products with decreasing sales"
= Same underlying intent
```

### 3. **A/B Testing**
```javascript
// Test different SQL variations
Version A: Simple join
Version B: Optimized with CTE
Track: Performance, accuracy, user preference
```

### 4. **Anomaly Detection**
```javascript
if (usageCount > 10 && negative > positive) {
  // Flag for review
  // "High usage but poor feedback - investigate"
}
```

### 5. **Automated SQL Optimization**
```javascript
// AI suggests improvements
"Detected N+1 query pattern"
"Recommend adding index on column X"
"Consider caching this query"
```

---

## Complete Feature Checklist

### UI Components âœ…
- âœ… New section with purple theme
- âœ… Query cards in 2-column grid
- âœ… Usage stats display
- âœ… User feedback counters
- âœ… Conversation count badge
- âœ… View Conversations button
- âœ… Conversations dialog
- âœ… Editable SQL view
- âœ… Dismiss button
- âœ… Add to Golden Set button

### Functionality âœ…
- âœ… Display new queries from conversations
- âœ… Show usage analytics
- âœ… Show user feedback stats
- âœ… View conversation details in dialog
- âœ… Edit SQL before adding
- âœ… Add validated query to golden set
- âœ… Dismiss unwanted queries
- âœ… Update header counter
- âœ… Toast notifications

### Data Management âœ…
- âœ… NewQuery interface
- âœ… Mock conversation data
- âœ… State management for new queries
- âœ… Handler for adding to golden set
- âœ… Handler for dismissing
- âœ… SQL editing state

---

## Summary

### What We Built
A **continuous improvement feedback loop** that:
1. Captures queries generated during user conversations
2. Shows usage analytics and user feedback
3. Lets analysts review conversation context
4. Allows SQL validation and editing
5. Adds validated queries to golden set

### Impact
- **For Analysts**: Data-driven curation of golden queries
- **For Users**: Faster, more accurate responses over time
- **For Product**: Self-improving knowledge base

### The Loop
```
User Asks â†’ AI Generates â†’ User Feedback â†’ Analyst Reviews â†’ Validates â†’ Golden Set
     â†‘                                                                      â†“
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Future Users Benefit â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Result: A living, breathing golden query set that evolves with actual usage!** ğŸ¯ğŸ”„âœ¨
